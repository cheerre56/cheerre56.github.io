<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Selection | Naha Parfums</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Space+Grotesk:wght@300;400&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #050505;
      --card-bg: rgba(20, 20, 20, 0.62);
      --text-color: #e0e0e0;
      --accent-color: #888;
      --accent-gold: #c5a367;
      --border-radius: 12px;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: "Space Grotesk", sans-serif;
      overflow-x: hidden;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    .gradient-bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(70, 60, 150, 0.16), transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(197, 163, 103, 0.1), transparent 40%);
      filter: blur(40px);
    }

    nav {
      padding: 2rem 4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-family: "Italiana", serif;
      font-size: 1.5rem;
      letter-spacing: 2px;
      color: #fff;
      text-decoration: none;
      transition: opacity 200ms ease;
    }

    .logo:hover {
      opacity: 0.72;
    }

    .back-link {
      font-size: 0.8rem;
      letter-spacing: 1px;
      color: var(--accent-color);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 200ms ease, color 200ms ease;
    }

    .back-link:hover {
      color: #fff;
      border-color: #fff;
    }

    .cart-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 4rem;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 4rem;
      opacity: 0;
      animation: fadeIn 720ms ease-out forwards;
    }

    .page-title {
      margin: 0 0 2rem;
      grid-column: 1 / -1;
      font-family: "Italiana", serif;
      font-size: 3rem;
      color: #fff;
      letter-spacing: 2px;
    }

    .cart-items {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .cart-item {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      background: var(--card-bg);
      padding: 1.2rem;
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: transform 220ms ease, border-color 220ms ease;
    }

    .cart-item:hover {
      transform: translateY(-2px);
      border-color: rgba(255, 255, 255, 0.14);
    }

    .item-thumb {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      background: rgba(255, 255, 255, 0.05);
      flex-shrink: 0;
    }

    .item-info {
      flex: 1;
      min-width: 0;
    }

    .item-name {
      margin-bottom: 0.3rem;
      font-family: "Italiana", serif;
      font-size: 1.2rem;
      color: #fff;
      letter-spacing: 1px;
    }

    .item-variant {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent-color);
    }

    .item-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .qty-selector {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 0.3rem 0.7rem;
    }

    .qty-btn {
      border: 0;
      background: none;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      transition: color 180ms ease;
    }

    .qty-btn:hover {
      color: var(--accent-gold);
    }

    .qty-val {
      width: 20px;
      text-align: center;
      font-size: 0.9rem;
    }

    .item-price {
      min-width: 100px;
      text-align: right;
      font-size: 0.95rem;
      letter-spacing: 1px;
    }

    .remove-btn {
      border: 0;
      background: none;
      color: var(--accent-color);
      cursor: pointer;
      font-size: 1.1rem;
      transition: color 180ms ease;
    }

    .remove-btn:hover {
      color: #ff6b6b;
    }

    .cart-summary {
      background: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: var(--border-radius);
      padding: 2rem;
      height: fit-content;
      position: sticky;
      top: 2rem;
    }

    .summary-title {
      margin: 0 0 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-family: "Italiana", serif;
      font-size: 1.5rem;
      letter-spacing: 1px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: var(--accent-color);
    }

    .summary-row.total {
      margin-top: 1.7rem;
      margin-bottom: 1.7rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .checkout-btn {
      width: 100%;
      padding: 1rem;
      border: 0;
      border-radius: 6px;
      background: #fff;
      color: #000;
      cursor: pointer;
      font-family: "Space Grotesk", sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: transform 180ms ease, background-color 180ms ease, color 180ms ease;
    }

    .checkout-btn:hover {
      background: var(--accent-gold);
      color: #fff;
      transform: scale(1.02);
    }

    .checkout-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .empty-cart-message {
      width: 100%;
      text-align: center;
      padding: 3rem 1.2rem;
      color: var(--accent-color);
      border: 1px dashed rgba(255, 255, 255, 0.15);
      border-radius: var(--border-radius);
      background: rgba(15, 15, 15, 0.5);
    }

    .empty-cart-message h2 {
      margin: 0 0 0.8rem;
      color: #fff;
      font-family: "Italiana", serif;
      font-size: 2rem;
    }

    .checkout-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }

    .checkout-modal.active {
      display: flex;
      animation: fadeIn 280ms ease-out;
    }

    .modal-content {
      width: 90%;
      max-width: 500px;
      padding: 2.5rem;
      text-align: center;
      border-radius: 20px;
      border: 1px solid rgba(197, 163, 103, 0.3);
      background: linear-gradient(135deg, rgba(20, 20, 20, 0.95) 0%, rgba(30, 30, 30, 0.95) 100%);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      animation: slideUp 360ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal-icon {
      margin-bottom: 1.2rem;
      font-size: 3rem;
      animation: pulse 2s ease-in-out infinite;
    }

    .modal-title {
      margin: 0 0 0.8rem;
      font-family: "Italiana", serif;
      font-size: 2rem;
      color: var(--accent-gold);
      letter-spacing: 2px;
    }

    .modal-subtitle {
      margin: 0 0 1.2rem;
      line-height: 1.6;
      color: #fff;
    }

    .modal-description {
      margin: 0 0 1.8rem;
      line-height: 1.7;
      color: var(--accent-color);
      font-style: italic;
      font-size: 0.9rem;
    }

    .modal-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.8rem;
    }

    .modal-btn {
      padding: 0.9rem 1.6rem;
      border-radius: 6px;
      border: 1px solid var(--accent-gold);
      background: transparent;
      color: var(--accent-gold);
      text-transform: uppercase;
      letter-spacing: 1.4px;
      font-family: "Space Grotesk", sans-serif;
      cursor: pointer;
      transition: transform 180ms ease, background-color 180ms ease, color 180ms ease;
    }

    .modal-btn:hover {
      background: var(--accent-gold);
      color: var(--bg-color);
      transform: scale(1.04);
    }

    .modal-btn.close-btn {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .modal-btn.close-btn:hover {
      background: var(--accent-color);
      color: #fff;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(28px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes pulse {
      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    @media (max-width: 1024px) {
      .cart-container {
        grid-template-columns: 1fr;
        padding: 2rem;
        gap: 2rem;
      }

      .page-title {
        font-size: 2.4rem;
      }

      .cart-summary {
        position: static;
      }
    }

    @media (max-width: 768px) {
      nav {
        padding: 1.5rem 2rem;
      }

      .cart-container {
        padding: 1rem 1.4rem;
      }

      .page-title {
        font-size: 1.8rem;
      }

      .cart-item {
        flex-wrap: wrap;
        gap: 1rem;
      }

      .item-thumb {
        width: 60px;
        height: 60px;
      }

      .item-controls {
        width: 100%;
        flex-wrap: wrap;
      }

      .item-price {
        min-width: auto;
      }

      .modal-content {
        padding: 1.6rem;
      }

      .modal-title {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="gradient-bg"></div>

  <div class="checkout-modal" id="checkoutModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-icon">*</div>
      <h2 class="modal-title">Coming Soon</h2>
      <p class="modal-subtitle">Payment gateway integration is not enabled yet.</p>
      <p class="modal-description">
        Checkout UI is ready and cart totals are calculated correctly.<br>
        You can continue browsing while payment integration is pending.
      </p>
      <div class="modal-buttons">
        <button class="modal-btn" id="modalCloseBtn" type="button">Back to Cart</button>
        <button class="modal-btn close-btn" id="modalShopBtn" type="button">Keep Shopping</button>
      </div>
    </div>
  </div>

  <nav>
    <a href="index.html" class="logo">naha.</a>
    <a href="index.html" class="back-link">Continue Shopping</a>
  </nav>

  <div class="cart-container">
    <h1 class="page-title">Your Selection</h1>

    <div class="cart-items" id="cartItems"></div>

    <div class="cart-summary">
      <h2 class="summary-title">Order Summary</h2>
      <div class="summary-row">
        <span>Subtotal</span>
        <span id="subtotal">NT$ 0</span>
      </div>
      <div class="summary-row">
        <span>Shipping</span>
        <span>Free</span>
      </div>
      <div class="summary-row total">
        <span>Total</span>
        <span id="total">NT$ 0</span>
      </div>
      <button class="checkout-btn" id="checkoutBtn" type="button">Checkout</button>
    </div>
  </div>

  <script src="assets/js/naha-catalog.js"></script>
  <script src="assets/js/naha-cart.js"></script>
  <script>
    const FALLBACK_IMAGE = "assets/media/images/perfume-placeholder.svg";

    function formatCurrency(value) {
      const normalized = Number(value);
      const safeValue = Number.isFinite(normalized) ? normalized : 0;
      return `NT$ ${safeValue.toLocaleString("en-US")}`;
    }

    function getLineItems() {
      if (!window.NahaCart || !window.NahaCatalog) {
        return [];
      }

      const cartState = window.NahaCart.getCart();
      return Object.entries(cartState.items)
        .map(([variantKey, item]) => {
          if (!item || typeof item !== "object") {
            return null;
          }

          const quantity = Math.max(0, Math.floor(Number(item.quantity || 0)));
          if (quantity <= 0) {
            return null;
          }

          const product = window.NahaCatalog.getProduct(item.productId);
          const variant = product ? window.NahaCatalog.getVariant(item.productId, item.volumeMl) : null;

          const unitPrice = Number(variant ? variant.price : item.unitPriceSnapshot) || 0;
          const volumeMl = Number(variant ? variant.volumeMl : item.volumeMl) || 0;
          const title =
            (item.titleSnapshot && String(item.titleSnapshot).trim()) ||
            (product && product.title) ||
            "Unknown Fragrance";

          return {
            variantKey,
            quantity,
            title,
            unitPrice,
            volumeMl,
            image: (product && product.image) || FALLBACK_IMAGE,
            variantLabel: volumeMl > 0 ? `${volumeMl}ml / Eau de Parfum` : "Legacy Item"
          };
        })
        .filter(Boolean);
    }

    function updateTotal(lineItems) {
      const total = lineItems.reduce((sum, item) => sum + item.unitPrice * item.quantity, 0);
      const formattedTotal = formatCurrency(total);
      document.getElementById("subtotal").innerText = formattedTotal;
      document.getElementById("total").innerText = formattedTotal;
    }

    function renderCart() {
      const cartItemsElement = document.getElementById("cartItems");
      const checkoutButton = document.getElementById("checkoutBtn");
      const lineItems = getLineItems();

      cartItemsElement.innerHTML = "";

      if (lineItems.length === 0) {
        cartItemsElement.innerHTML = `
          <div class="empty-cart-message">
            <h2>Your cart is empty</h2>
            <p>Add some fragrances to get started.</p>
          </div>
        `;
        checkoutButton.disabled = true;
        updateTotal([]);
        return;
      }

      checkoutButton.disabled = false;

      lineItems.forEach((lineItem) => {
        const itemTotal = lineItem.unitPrice * lineItem.quantity;
        const itemElement = document.createElement("div");
        itemElement.className = "cart-item";
        itemElement.dataset.key = lineItem.variantKey;

        itemElement.innerHTML = `
          <img src="${lineItem.image}" alt="${lineItem.title}" class="item-thumb">
          <div class="item-info">
            <div class="item-name">${lineItem.title}</div>
            <div class="item-variant">${lineItem.variantLabel}</div>
          </div>
          <div class="item-controls">
            <div class="qty-selector">
              <button class="qty-btn minus" type="button">-</button>
              <span class="qty-val">${lineItem.quantity}</span>
              <button class="qty-btn plus" type="button">+</button>
            </div>
            <div class="item-price">${formatCurrency(itemTotal)}</div>
            <button class="remove-btn" type="button">x</button>
          </div>
        `;

        itemElement.querySelector(".minus").addEventListener("click", () => {
          window.NahaCart.updateItemQty(lineItem.variantKey, lineItem.quantity - 1);
        });

        itemElement.querySelector(".plus").addEventListener("click", () => {
          window.NahaCart.updateItemQty(lineItem.variantKey, lineItem.quantity + 1);
        });

        itemElement.querySelector(".remove-btn").addEventListener("click", () => {
          window.NahaCart.removeItem(lineItem.variantKey);
        });

        cartItemsElement.appendChild(itemElement);
      });

      updateTotal(lineItems);
    }

    function openCheckoutModal() {
      const modal = document.getElementById("checkoutModal");
      modal.classList.add("active");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeCheckoutModal() {
      const modal = document.getElementById("checkoutModal");
      modal.classList.remove("active");
      modal.setAttribute("aria-hidden", "true");
    }

    function goShopping() {
      window.location.href = "index.html";
    }

    function checkout() {
      if (getLineItems().length === 0) {
        return;
      }

      openCheckoutModal();
    }

    document.getElementById("checkoutBtn").addEventListener("click", checkout);
    document.getElementById("modalCloseBtn").addEventListener("click", closeCheckoutModal);
    document.getElementById("modalShopBtn").addEventListener("click", goShopping);

    document.getElementById("checkoutModal").addEventListener("click", (event) => {
      if (event.target.id === "checkoutModal") {
        closeCheckoutModal();
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      if (window.NahaCart) {
        window.NahaCart.migrateLegacyCart();
      }

      renderCart();
    });

    window.addEventListener("naha:cart-updated", renderCart);
  </script>
</body>
</html>

