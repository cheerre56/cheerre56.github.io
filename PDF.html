<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuvexPDF - GitHub Pages ä¿®å¾©ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ‹–æ›³è¦–è¦ºæ¨£å¼ */
        .dragging-source { opacity: 0.4; background: #f3f4f6; border: 2px dashed #9ca3af; }
        .drag-target-hover {
            transform: scale(1.02);
            box-shadow: 0 0 0 2px #3b82f6 !important;
            background-color: #eff6ff !important;
            z-index: 10;
            position: relative;
        }
        .draggable-item { cursor: grab; transition: transform 0.2s; }
        .draggable-item:active { cursor: grabbing; }
        .page-card { cursor: grab; transition: transform 0.2s; }
        .page-card:active { cursor: grabbing; }
        .drag-over-zone { background-color: #eff6ff !important; border-color: #3b82f6 !important; transform: scale(1.01); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800">

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-slate-800 mb-2">
                <span class="text-blue-600">Nuvex</span>PDF
            </h1>
            <p class="text-slate-500 text-sm">å…¨åŸŸæ‹–æ›³ â€¢ é‚Šç·£è‡ªå‹•æ²å‹• â€¢ é›™æ“Šç·¨è¼¯</p>
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden min-h-[500px]">
            <div class="flex border-b border-gray-100 bg-gray-50">
                <button onclick="switchTab('merge')" id="tab-merge" class="flex-1 py-4 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-white">
                    <i class="fas fa-layer-group mr-2"></i>åˆä½µ PDF
                </button>
                <button onclick="switchTab('unlock')" id="tab-unlock" class="flex-1 py-4 text-sm font-bold text-gray-500 hover:text-gray-700">
                    <i class="fas fa-unlock-alt mr-2"></i>è§£é– PDF
                </button>
            </div>

            <div class="p-6 md:p-8 relative">
                <div id="section-merge">
                    <div id="drop-zone-merge" class="relative group mb-6">
                        <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer bg-slate-50 hover:bg-blue-50 hover:border-blue-400 transition duration-200">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6 pointer-events-none">
                                <i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
                                <p class="text-sm font-medium text-slate-700">é»æ“Šæˆ–æ‹–æ›³å¤šå€‹æª”æ¡ˆ</p>
                            </div>
                            <input type="file" id="merge-input" class="hidden" multiple accept="application/pdf" onchange="handleMergeFiles(this.files)">
                        </label>
                    </div>

                    <div id="merge-ui-container" class="hidden">
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="text-sm font-bold text-slate-700">æª”æ¡ˆåˆ—è¡¨ (<span id="file-count">0</span>)</h3>
                            <span class="text-xs text-blue-500 bg-blue-50 px-2 py-1 rounded select-none">
                                <i class="fas fa-mouse-pointer mr-1"></i> é›™æ“Šå¡ç‰‡ç·¨è¼¯é é¢
                            </span>
                        </div>
                        <div id="file-list" class="space-y-3 mb-8"></div>
                        <div class="flex flex-col gap-3">
                            <button onclick="executeMerge()" id="btn-merge" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg shadow-blue-200 transition flex justify-center items-center gap-2">
                                <span>é–‹å§‹åˆä½µ PDF</span>
                            </button>
                            <a id="merge-download" href="#" class="hidden w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-bold shadow-lg shadow-emerald-200 transition text-center flex justify-center items-center gap-2">
                                <i class="fas fa-check-circle"></i> <span>ä¸‹è¼‰åˆä½µæª”æ¡ˆ</span>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="section-unlock" class="hidden">
                    <div id="drop-zone-unlock" class="mb-6">
                        <label class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer bg-slate-50 hover:bg-purple-50 hover:border-purple-400 transition duration-200">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6 pointer-events-none">
                                <i class="fas fa-lock text-3xl text-purple-500 mb-2"></i>
                                <p class="text-sm font-medium text-slate-700" id="unlock-filename">ä¸Šå‚³åŠ å¯† PDF</p>
                            </div>
                            <input type="file" id="unlock-input" class="hidden" accept="application/pdf" onchange="handleUnlockFile(this.files)">
                        </label>
                    </div>
                    <div class="mt-4">
                        <input type="password" id="pdf-password" placeholder="è¼¸å…¥å¯†ç¢¼..." class="w-full bg-slate-50 border border-slate-200 rounded-lg py-3 px-4 text-slate-700 focus:outline-none focus:border-purple-500">
                    </div>
                    <button onclick="executeUnlock()" id="btn-unlock" class="mt-6 w-full py-4 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold shadow-lg shadow-purple-200 transition">
                        è§£é™¤å¯†ç¢¼ä¸¦ä¸‹è¼‰
                    </button>
                    <p id="unlock-status" class="mt-4 text-center text-sm font-bold h-6"></p>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-8 text-slate-400 text-xs">NuvexPDF Â© 2025</div>
    </div>

    <div id="page-editor-modal" class="fixed inset-0 z-50 hidden bg-gray-900/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <div>
                    <h3 class="text-xl font-bold text-slate-800" id="editor-filename">ç·¨è¼¯é é¢</h3>
                    <p class="text-xs text-slate-500">æ‹–æ›³èª¿æ•´é †åº â€¢ é»æ“Š X åˆªé™¤</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="closeEditor()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                    <button onclick="saveEditorChanges()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow">
                        ç¢ºèªä¿®æ”¹
                    </button>
                </div>
            </div>

            <div id="modal-scroll-container" class="flex-1 overflow-y-auto p-5 bg-slate-50 relative scroll-smooth">
                <div id="editor-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-50 z-10 hidden">
                    <div class="loader w-10 h-10 border-4 border-blue-500 mb-4"></div>
                    <p class="text-slate-500 font-bold">æ­£åœ¨è®€å–é é¢...</p>
                </div>
                <div id="page-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            </div>
            
            <div class="p-4 border-t border-gray-100 text-xs text-slate-400 flex justify-between">
                <span>ä¿ç•™é æ•¸: <b id="editor-page-count" class="text-blue-600">0</b></span>
                <span>æŒ‰ä½æ‹–æ›³è‡³é‚Šç·£å¯è‡ªå‹•æ²å‹•</span>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸéŒ¯èª¤æ•æ‰ (Debug Mode) ---
        window.onerror = function(message, source, lineno, colno, error) {
            console.error(error);
            // åªæœ‰ç•¶å‡ºç¾ pdfjsLib ç›¸é—œéŒ¯èª¤æ™‚æ‰è­¦å‘Š
            if(message.includes('pdfjsLib') || message.includes('PDFLib')) {
                alert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š\nå¯èƒ½æ˜¯ç¶²è·¯ä¸ç©©å°è‡´è³‡æºæœªè¼‰å…¥ã€‚\nè«‹å˜—è©¦é‡æ–°æ•´ç†ç¶²é ã€‚\n\néŒ¯èª¤è¨Šæ¯: " + message);
            }
        };

        // --- Data Model ---
        let mergeFiles = [];
        let unlockFile = null;
        let currentEditingFileId = null;
        let editorPagesData = []; 
        let isDraggingPage = false;
        let currentMouseY = 0;
        let scrollAnimationId = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åˆå§‹åŒ– PDF Worker (é€™æ˜¯ GitHub Pages ä¿®å¾©çš„é—œéµ)
            await initPdfWorker();

            // 2. åˆå§‹åŒ–äº‹ä»¶ç›£è½
            setupUploadZone('drop-zone-merge', handleMergeFiles);
            setupUploadZone('drop-zone-unlock', handleUnlockFile);
            initAutoScroll();
        });

        // ğŸ”¥ é—œéµä¿®å¾©ï¼šç¹é CORS é™åˆ¶è¼‰å…¥ Worker ğŸ”¥
        async function initPdfWorker() {
            if (typeof pdfjsLib === 'undefined') {
                console.error("PDF.js library not loaded!");
                return;
            }
            
            const workerUrl = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
            
            try {
                // å˜—è©¦å°‡ Worker ç¨‹å¼ç¢¼ä¸‹è¼‰ä¸‹ä¾†ï¼Œè½‰æˆ Blob
                // é€™æ¨£ç€è¦½å™¨æœƒèªç‚ºé€™æ˜¯ã€Œæœ¬åœ°ã€ç¨‹å¼ç¢¼ï¼Œå°±ä¸æœƒæ“‹æ‰
                const response = await fetch(workerUrl);
                if (!response.ok) throw new Error("Worker fetch failed");
                const workerScript = await response.text();
                const blob = new Blob([workerScript], { type: "text/javascript" });
                const blobUrl = URL.createObjectURL(blob);
                
                pdfjsLib.GlobalWorkerOptions.workerSrc = blobUrl;
                console.log("PDF Worker loaded via Blob (CORS Bypass Success)");
            } catch (e) {
                console.warn("Blob worker failed, falling back to CDN URL", e);
                // å¦‚æœä¸‹è¼‰å¤±æ•—ï¼Œæ‰ä½¿ç”¨åŸæœ¬çš„ CDN é€£çµ (ç•¶ä½œæœ€å¾Œæ‰‹æ®µ)
                pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;
            }
        }

        // --- Auto Scroll ---
        function initAutoScroll() {
            const container = document.getElementById('modal-scroll-container');
            document.addEventListener('dragover', (e) => {
                if (isDraggingPage) currentMouseY = e.clientY;
            });
            function scrollLoop() {
                if (isDraggingPage) {
                    const rect = container.getBoundingClientRect();
                    const threshold = 100; 
                    const scrollSpeed = 15; 
                    if (currentMouseY > 0) {
                        if (currentMouseY < rect.top + threshold) container.scrollTop -= scrollSpeed;
                        else if (currentMouseY > rect.bottom - threshold) container.scrollTop += scrollSpeed;
                    }
                }
                scrollAnimationId = requestAnimationFrame(scrollLoop);
            }
            scrollAnimationId = requestAnimationFrame(scrollLoop);
        }

        function setupUploadZone(id, callback) {
            const el = document.getElementById(id);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                el.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(e => el.addEventListener(e, () => el.classList.add('drag-over-zone')));
            ['dragleave', 'drop'].forEach(e => el.addEventListener(e, () => el.classList.remove('drag-over-zone')));
            el.addEventListener('drop', (e) => callback(e.dataTransfer.files));
        }

        function switchTab(tab) {
            ['merge', 'unlock'].forEach(t => {
                document.getElementById(`section-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = "flex-1 py-4 text-sm font-bold text-gray-500 hover:text-gray-700 border-b border-transparent";
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.className = "flex-1 py-4 text-sm font-bold border-b-2 bg-white";
            if(tab === 'merge') activeBtn.classList.add('text-blue-600', 'border-blue-600');
            else activeBtn.classList.add('text-purple-600', 'border-purple-600');
        }

        // ================= MERGE FILE LIST =================
        async function handleMergeFiles(fileList) {
            if (!fileList || fileList.length === 0) return;
            // æª¢æŸ¥ PDFLib æ˜¯å¦å­˜åœ¨
            if (typeof PDFLib === 'undefined') { alert("æ ¸å¿ƒçµ„ä»¶å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é‡æ–°æ•´ç†"); return; }

            document.getElementById('merge-ui-container').classList.remove('hidden');

            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];
                if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) continue;

                const fileId = Date.now() + Math.random().toString(36).substr(2, 9);
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                    const pdf = await loadingTask.promise;

                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 0.3 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    const indices = Array.from({ length: pdf.numPages }, (_, k) => k);

                    mergeFiles.push({
                        id: fileId,
                        file: file,
                        name: file.name,
                        originalPageCount: pdf.numPages,
                        pageIndices: indices,
                        thumbnail: canvas.toDataURL()
                    });
                } catch (err) {
                    console.error("Error parsing PDF:", err);
                    alert(`ç„¡æ³•è®€å–æª”æ¡ˆ ${file.name}ï¼Œå¯èƒ½æ˜¯æª”æ¡ˆææ¯€æˆ–åŠ å¯†ã€‚`);
                }
            }
            
            document.getElementById('merge-input').value = '';
            renderMergeList();
        }

        function renderMergeList() {
            const listEl = document.getElementById('file-list');
            document.getElementById('file-count').innerText = mergeFiles.length;
            listEl.innerHTML = '';

            mergeFiles.forEach((item, displayIndex) => {
                const el = document.createElement('div');
                el.className = "draggable-item bg-white border border-slate-200 rounded-lg p-3 flex items-center gap-4 relative shadow-sm hover:shadow-md cursor-pointer group select-none";
                el.draggable = true;
                el.ondblclick = () => openPageEditor(item.id);
                el.title = "é›™æ“Šå…©ä¸‹ä»¥ç·¨è¼¯é é¢";

                el.innerHTML = `
                    <div class="cursor-move text-slate-300 hover:text-slate-500 px-1">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="relative pointer-events-none">
                        <img src="${item.thumbnail}" class="w-16 h-20 object-contain bg-slate-50 border rounded shadow-sm">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition rounded flex items-center justify-center">
                            <i class="fas fa-edit text-white opacity-0 group-hover:opacity-100 drop-shadow-md"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0 pointer-events-none">
                        <h4 class="text-sm font-bold text-slate-700 truncate">${item.name}</h4>
                        <p class="text-xs text-slate-500 mt-1">
                            åŒ…å« <span class="font-bold text-blue-600 bg-blue-50 px-1 rounded">${item.pageIndices.length}</span> é  
                            <span class="text-gray-300">/ åŸ ${item.originalPageCount} é </span>
                        </p>
                    </div>
                    <button onclick="removeFile('${item.id}')" class="text-slate-400 hover:text-red-500 p-2 transition z-10">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;

                el.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/type', 'file_item');
                    e.dataTransfer.setData('text/index', displayIndex);
                    el.classList.add('dragging-source');
                });
                el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('drag-target-hover'); });
                el.addEventListener('dragleave', () => { el.classList.remove('drag-target-hover'); });
                el.addEventListener('drop', (e) => {
                    e.preventDefault();
                    el.classList.remove('drag-target-hover'); 
                    if (e.dataTransfer.getData('text/type') !== 'file_item') return;
                    const fromIndex = parseInt(e.dataTransfer.getData('text/index'));
                    const toIndex = displayIndex;
                    if (fromIndex !== toIndex && !isNaN(fromIndex)) {
                        const movedItem = mergeFiles[fromIndex];
                        mergeFiles.splice(fromIndex, 1);
                        mergeFiles.splice(toIndex, 0, movedItem);
                        renderMergeList();
                    }
                });
                el.addEventListener('dragend', () => {
                    el.classList.remove('dragging-source');
                    document.querySelectorAll('.drag-target-hover').forEach(i => i.classList.remove('drag-target-hover'));
                });
                listEl.appendChild(el);
            });
            updateMergeBtnState();
        }

        function removeFile(id) {
            mergeFiles = mergeFiles.filter(f => f.id !== id);
            renderMergeList();
        }

        // ================= PAGE EDITOR LOGIC =================
        async function openPageEditor(fileId) {
            const fileObj = mergeFiles.find(f => f.id === fileId);
            if (!fileObj) return;
            currentEditingFileId = fileId;
            editorPagesData = []; 
            const modal = document.getElementById('page-editor-modal');
            const grid = document.getElementById('page-grid');
            const loader = document.getElementById('editor-loading');
            
            document.getElementById('editor-filename').innerText = fileObj.name;
            modal.classList.remove('hidden');
            grid.innerHTML = ''; 
            loader.classList.remove('hidden');

            try {
                const arrayBuffer = await fileObj.file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

                for (let i = 0; i < fileObj.pageIndices.length; i++) {
                    const originalIndex = fileObj.pageIndices[i];
                    const page = await pdf.getPage(originalIndex + 1); 
                    const scale = 0.3;
                    const viewport = page.getViewport({ scale });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    editorPagesData.push({ originalIndex: originalIndex, imgSrc: canvas.toDataURL() });
                }
                renderEditorGrid(); 
            } catch(e) {
                console.error(e);
                alert("ç„¡æ³•è®€å–é é¢");
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderEditorGrid() {
            const grid = document.getElementById('page-grid');
            grid.innerHTML = ''; 
            editorPagesData.forEach((pageData, displayIndex) => {
                const div = document.createElement('div');
                div.className = "page-card bg-white p-2 rounded shadow border border-gray-200 relative group select-none transition-transform";
                div.draggable = true;
                div.innerHTML = `
                    <div class="absolute top-1 right-1 z-10">
                        <button onclick="removePageInEditor(${displayIndex})" class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow hover:bg-red-600 transition text-xs">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="w-full aspect-[1/1.4] bg-gray-100 mb-2 overflow-hidden rounded border border-gray-100 pointer-events-none">
                        <img src="${pageData.imgSrc}" class="w-full h-full object-contain">
                    </div>
                    <div class="text-center text-xs text-gray-400 font-mono">åŸå§‹é  ${pageData.originalIndex + 1}</div>
                `;
                div.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/type', 'page_item');
                    e.dataTransfer.setData('text/index', displayIndex);
                    div.classList.add('dragging-source');
                    isDraggingPage = true;
                });
                div.addEventListener('dragover', (e) => { e.preventDefault(); div.classList.add('drag-target-hover'); });
                div.addEventListener('dragleave', () => { div.classList.remove('drag-target-hover'); });
                div.addEventListener('drop', (e) => {
                    e.preventDefault();
                    div.classList.remove('drag-target-hover');
                    isDraggingPage = false;
                    if(e.dataTransfer.getData('text/type') !== 'page_item') return;
                    const fromIndex = parseInt(e.dataTransfer.getData('text/index'));
                    const toIndex = displayIndex;
                    if (fromIndex !== toIndex && !isNaN(fromIndex)) {
                        const item = editorPagesData[fromIndex];
                        editorPagesData.splice(fromIndex, 1);
                        editorPagesData.splice(toIndex, 0, item);
                        renderEditorGrid();
                    }
                });
                div.addEventListener('dragend', () => {
                    div.classList.remove('dragging-source');
                    document.querySelectorAll('.drag-target-hover').forEach(el => el.classList.remove('drag-target-hover'));
                    isDraggingPage = false;
                });
                grid.appendChild(div);
            });
            document.getElementById('editor-page-count').innerText = editorPagesData.length;
        }

        function removePageInEditor(index) { editorPagesData.splice(index, 1); renderEditorGrid(); }
        function saveEditorChanges() {
            const fileObj = mergeFiles.find(f => f.id === currentEditingFileId);
            if(fileObj) fileObj.pageIndices = editorPagesData.map(p => p.originalIndex);
            closeEditor(); renderMergeList(); 
        }
        function closeEditor() {
            document.getElementById('page-editor-modal').classList.add('hidden');
            currentEditingFileId = null; editorPagesData = []; isDraggingPage = false; 
        }

        // ================= FINAL MERGE EXECUTION =================
        function updateMergeBtnState() {
            const btn = document.getElementById('btn-merge');
            if (mergeFiles.length < 2) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = '<span>è‡³å°‘éœ€è¦ 2 å€‹æª”æ¡ˆ</span>';
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerHTML = '<span>é–‹å§‹åˆä½µ PDF</span>';
            }
        }

        async function executeMerge() {
            if (mergeFiles.length < 2) return;
            const btn = document.getElementById('btn-merge');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader mr-2"></div> è™•ç†ä¸­...';
            btn.disabled = true;
            try {
                const { PDFDocument } = PDFLib; // ç¢ºä¿ PDFLib å·²ç¶“ loaded
                const mergedPdf = await PDFDocument.create();
                for (const item of mergeFiles) {
                    if (item.pageIndices.length === 0) continue; 
                    const arrayBuffer = await item.file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, item.pageIndices);
                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                }
                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const now = new Date();
                const pad = (n) => String(n).padStart(2, '0');
                const timeStr = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}`;
                const filename = `NuvexPDF_${timeStr}.pdf`;
                const downloadBtn = document.getElementById('merge-download');
                downloadBtn.href = url;
                downloadBtn.download = filename;
                btn.classList.add('hidden');
                downloadBtn.classList.remove('hidden');
            } catch (err) {
                console.error(err);
                alert("åˆä½µå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æ­£å¸¸ã€‚");
            } finally {
                if (document.getElementById('merge-download').classList.contains('hidden')) {
                     btn.innerHTML = originalText;
                     btn.disabled = false;
                }
            }
        }

        // ================= UNLOCK LOGIC =================
        function handleUnlockFile(fileList) {
            if (fileList && fileList[0]) {
                const f = fileList[0];
                if (f.type !== 'application/pdf' && !f.name.toLowerCase().endsWith('.pdf')) return;
                unlockFile = f;
                document.getElementById('unlock-filename').innerHTML = `<span class="text-purple-600 font-bold">${f.name}</span>`;
            }
            document.getElementById('unlock-input').value = '';
        }

        async function executeUnlock() {
            if (!unlockFile) { alert("è«‹å…ˆä¸Šå‚³æª”æ¡ˆ"); return; }
            const password = document.getElementById('pdf-password').value;
            const btn = document.getElementById('btn-unlock');
            const status = document.getElementById('unlock-status');
            btn.innerHTML = '<div class="loader inline-block mr-2"></div> è§£å¯†ä¸­...';
            btn.disabled = true;
            status.innerText = "";
            try {
                const { PDFDocument } = PDFLib;
                const arrayBuffer = await unlockFile.arrayBuffer();
                const pdf = await PDFDocument.load(arrayBuffer, { password: password });
                const pdfBytes = await pdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `unlocked_${unlockFile.name}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                status.innerText = "è§£é–æˆåŠŸï¼";
                status.className = "mt-4 text-center text-sm font-bold text-green-600";
            } catch (err) {
                status.innerText = "å¯†ç¢¼éŒ¯èª¤æˆ–æª”æ¡ˆæœªåŠ å¯†";
                status.className = "mt-4 text-center text-sm font-bold text-red-600";
            } finally {
                btn.innerHTML = "è§£é™¤å¯†ç¢¼ä¸¦ä¸‹è¼‰";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
