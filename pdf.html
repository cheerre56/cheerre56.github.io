<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuvexPDF - 現代極速版</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 24px 24px; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 拖曳動畫 */
        .draggable-item { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: grab; }
        .draggable-item:active { cursor: grabbing; transform: scale(0.99); }
        .draggable-item:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

        .dragging-source { opacity: 0.5; background: #f1f5f9; border: 2px dashed #cbd5e1; }
        
        .drag-target-hover {
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3) !important;
            border-color: #6366f1 !important;
            background-color: #eef2ff !important;
            z-index: 10;
        }

        /* 側邊欄插入樣式 */
        .sidebar-insert-hover {
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.3) !important;
            border-color: #10b981 !important;
            background-color: #ecfdf5 !important;
            z-index: 20;
        }

        .page-card { cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
        .page-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .drag-over-zone { background-color: #eef2ff !important; border-color: #6366f1 !important; transform: scale(1.01); }
        
        #editor-drop-overlay { background-color: rgba(255, 255, 255, 0.95); border: 4px dashed #6366f1; pointer-events: none; z-index: 50; }
        
        .sidebar-item { cursor: grab; transition: all 0.2s; }
        .sidebar-item:hover { background-color: #f8fafc; }
        .sidebar-target-hover { border-left: 4px solid #6366f1 !important; background-color: #eef2ff !important; padding-left: 12px; }

        /* 卷軸美化 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="font-sans text-slate-700 min-h-screen flex flex-col">

    <div class="flex-1 container mx-auto px-4 py-12 max-w-5xl">
        
        <div class="text-center mb-12">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg shadow-indigo-500/30 mb-6">
                <i class="fas fa-layer-group text-3xl text-white"></i>
            </div>
            <h1 class="text-4xl font-extrabold text-slate-800 mb-3 tracking-tight">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Nuvex</span>PDF
            </h1>
            <p class="text-slate-500 text-lg">新世代極速 PDF 合併工具</p>
        </div>

        <div class="glass-panel rounded-3xl shadow-2xl overflow-hidden border border-white/50">
            
            <div class="px-8 py-6 border-b border-slate-100 flex items-center justify-between bg-white/50">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 font-bold text-sm">1</span>
                    <h2 class="text-lg font-bold text-slate-700">上傳與合併</h2>
                </div>
                <div class="text-xs font-medium text-slate-400 bg-slate-100 px-3 py-1 rounded-full">
                    <i class="fas fa-shield-alt mr-1"></i> 本機處理，檔案不需上傳
                </div>
            </div>

            <div class="p-8">
                <div id="drop-zone-merge" class="group relative mb-8">
                    <label class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-300 rounded-2xl cursor-pointer bg-slate-50/50 hover:bg-indigo-50/50 hover:border-indigo-400 transition-all duration-300 group-hover:shadow-inner">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 pointer-events-none transition-transform duration-300 group-hover:scale-105">
                            <div class="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mb-4">
                                <i class="fas fa-cloud-upload-alt text-3xl text-indigo-500"></i>
                            </div>
                            <p class="text-lg font-bold text-slate-700 mb-1">點擊或拖曳檔案至此</p>
                            <p class="text-sm text-slate-400">支援 PDF 格式，自動偵測加密</p>
                        </div>
                        <input type="file" id="merge-input" class="hidden" multiple accept="application/pdf" onchange="handleMergeFiles(this.files)">
                    </label>
                </div>

                <div id="merge-ui-container" class="hidden animate-fade-in-up">
                    <div class="flex justify-between items-end mb-4 px-1">
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">待合併檔案 (<span id="file-count" class="text-indigo-600">0</span>)</h3>
                        <span class="text-xs text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full font-medium border border-indigo-100 select-none">
                            <i class="fas fa-mouse-pointer mr-1"></i> 雙擊卡片開啟編輯器
                        </span>
                    </div>

                    <div id="file-list" class="space-y-3 mb-8">
                        </div>

                    <div class="flex flex-col sm:flex-row gap-4 pt-4 border-t border-slate-100">
                        <button onclick="executeMerge()" id="btn-merge" class="flex-1 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all active:scale-[0.98] flex justify-center items-center gap-2">
                            <i class="fas fa-bolt"></i> <span>開始合併 PDF</span>
                        </button>
                        
                        <a id="merge-download" href="#" class="hidden flex-1 py-4 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/30 transition-all active:scale-[0.98] text-center flex justify-center items-center gap-2">
                            <i class="fas fa-check-circle"></i> <span>下載合併檔案</span>
                        </a>
                    </div>
                </div>

                <div id="empty-state-hint" class="text-center py-10 text-slate-400 text-sm">
                    尚未選擇任何檔案
                </div>

            </div>
        </div>

        <div class="text-center mt-12 text-slate-400 text-xs">
            <p>NuvexPDF © 2025 • Secure & Fast</p>
        </div>
    </div>

    <div id="page-editor-modal" class="fixed inset-0 z-50 hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col relative overflow-hidden ring-1 ring-white/20">
            
            <div id="editor-drop-overlay" class="absolute inset-0 hidden flex flex-col items-center justify-center text-indigo-600 bg-white/95 backdrop-blur-sm z-50">
                <i class="fas fa-file-import text-6xl mb-6 animate-bounce"></i>
                <p class="text-3xl font-bold">放開以插入頁面</p>
            </div>

            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-white z-30">
                <div>
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="w-2 h-6 bg-indigo-500 rounded-full"></span>
                        <span id="editor-filename">頁面編輯器</span>
                    </h3>
                    <p class="text-xs text-slate-500 mt-1 pl-4">
                        拖曳可排序 • 雙擊刪除 • <span class="text-indigo-600 font-bold">支援跨檔案拖放</span>
                    </p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeEditor()" class="px-5 py-2.5 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold transition">取消</button>
                    <button id="btn-save-editor" onclick="saveEditorChanges()" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-md shadow-indigo-500/20 flex items-center gap-2 transition active:scale-95">
                        <i class="fas fa-save"></i> <span>確認修改</span>
                    </button>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden relative bg-slate-50">
                <div id="modal-scroll-container" class="flex-1 overflow-y-auto p-6 scroll-smooth">
                    <div id="editor-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-20 hidden backdrop-blur-sm">
                        <div class="loader w-12 h-12 border-4 border-indigo-500 mb-4"></div>
                        <p class="text-slate-600 font-bold mt-2 animate-pulse" id="editor-loading-text">讀取中...</p>
                    </div>
                    <div id="page-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 pb-20"></div>
                </div>

                <div class="w-72 bg-white border-l border-slate-200 flex flex-col shadow-xl z-20">
                    <div class="p-4 bg-slate-50 border-b border-slate-200 font-bold text-xs text-slate-500 uppercase tracking-wide flex justify-between items-center">
                        <span>資源庫 (其他檔案)</span>
                        <i class="fas fa-box-open text-slate-400"></i>
                    </div>
                    <div id="sidebar-file-list" class="flex-1 overflow-y-auto p-3 space-y-3"></div>
                    <div class="p-4 bg-indigo-50 text-xs text-indigo-600 text-center border-t border-indigo-100 font-medium">
                        <i class="fas fa-lightbulb mb-1 block text-lg"></i>
                        將檔案拖曳至左側<br>即可插入指定位置
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-3 border-t border-slate-100 text-xs text-slate-400 flex justify-between bg-white z-30">
                <span>目前頁數: <b id="editor-page-count" class="text-indigo-600 text-sm">0</b></span>
                <span class="flex items-center gap-2"><div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div> 系統就緒</span>
            </div>
        </div>
    </div>

    <script>
        window.onerror = function(m) { if (!m.includes('pdfjsLib') && !m.includes('tailwindcss')) console.error(m); };

        let mergeFiles = [], currentEditingFileId = null, editorPagesData = [], isDraggingPage = false;
        let currentMouseY = 0, scrollAnimationId = null, editorDragCounter = 0, imageObserver = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await initPdfWorker();
            setupUploadZone('drop-zone-merge', handleMergeFiles);
            initAutoScroll();
            setupEditorDropZone(); 
            imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        loadPageThumbnail(parseInt(entry.target.dataset.idx), entry.target);
                        imageObserver.unobserve(entry.target);
                    }
                });
            }, { root: document.getElementById('modal-scroll-container'), rootMargin: "200px" });
        });

        async function initPdfWorker() {
            if (typeof pdfjsLib === 'undefined') return;
            const u = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
            try {
                const r = await fetch(u); if(!r.ok) throw new Error();
                pdfjsLib.GlobalWorkerOptions.workerSrc = URL.createObjectURL(new Blob([await r.text()], {type:"text/javascript"}));
            } catch (e) { pdfjsLib.GlobalWorkerOptions.workerSrc = u; }
        }

        async function getFileArrayBuffer(fileItem) {
            return fileItem.blob ? await fileItem.blob.arrayBuffer() : await fileItem.file.arrayBuffer();
        }

        async function smartLoadPdf(arrayBuffer, password) {
            const { PDFDocument } = PDFLib;
            try { return await PDFDocument.load(arrayBuffer); } 
            catch (e) {
                if (e.message.includes('encrypted')) {
                    if (password) return await PDFDocument.load(arrayBuffer, { password: password });
                    try { return await PDFDocument.load(arrayBuffer, { password: '' }); } 
                    catch (e2) { throw e; }
                } throw e; 
            }
        }

        function setupUploadZone(id, callback) {
            const el = document.getElementById(id);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                el.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(e => el.addEventListener(e, () => el.classList.add('scale-[1.01]', 'border-indigo-400', 'bg-indigo-50')));
            ['dragleave', 'drop'].forEach(e => el.addEventListener(e, () => el.classList.remove('scale-[1.01]', 'border-indigo-400', 'bg-indigo-50')));
            el.addEventListener('drop', (e) => callback(e.dataTransfer.files));
        }

        async function handleMergeFiles(fileList) {
            if (!fileList || fileList.length === 0) return;
            document.getElementById('merge-ui-container').classList.remove('hidden');
            document.getElementById('empty-state-hint').classList.add('hidden'); // Hide hint

            for (let i = 0; i < fileList.length; i++) {
                const file = fileList[i];
                if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) continue;
                const fileId = Date.now() + Math.random().toString(36).substr(2, 9);
                try {
                    let arrayBuffer = await file.arrayBuffer();
                    let pdfDoc;
                    try {
                        pdfDoc = await smartLoadPdf(arrayBuffer.slice(0));
                        if (pdfDoc.isEncrypted) {
                            const decryptedBytes = await pdfDoc.save();
                            arrayBuffer = decryptedBytes.buffer; 
                            file.decryptedBlob = new Blob([decryptedBytes], { type: 'application/pdf' });
                        }
                    } catch (e) {
                        const pwd = prompt(`檔案「${file.name}」需要開啟密碼：`);
                        if (pwd) {
                            try {
                                pdfDoc = await smartLoadPdf(arrayBuffer.slice(0), pwd);
                                const decryptedBytes = await pdfDoc.save();
                                arrayBuffer = decryptedBytes.buffer; 
                                file.decryptedBlob = new Blob([decryptedBytes], { type: 'application/pdf' });
                            } catch { alert(`密碼錯誤，略過「${file.name}」。`); continue; }
                        } else { continue; }
                    }
                    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer.slice(0) });
                    const pdfProxy = await loadingTask.promise;
                    const page = await pdfProxy.getPage(1);
                    const viewport = page.getViewport({ scale: 0.3 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    const indices = Array.from({ length: pdfProxy.numPages }, (_, k) => k);
                    mergeFiles.push({
                        id: fileId, file: file, name: file.name,
                        originalPageCount: pdfProxy.numPages, pageIndices: indices,
                        thumbnail: canvas.toDataURL(), blob: file.decryptedBlob || null 
                    });
                } catch (err) { console.error("Load failed:", err); }
            }
            document.getElementById('merge-input').value = '';
            renderMergeList();
        }

        function renderMergeList() {
            const listEl = document.getElementById('file-list');
            document.getElementById('file-count').innerText = mergeFiles.length;
            listEl.innerHTML = '';
            mergeFiles.forEach((item, displayIndex) => {
                const el = document.createElement('div');
                el.className = "draggable-item bg-white border border-slate-200 rounded-xl p-4 flex items-center gap-5 relative shadow-sm cursor-pointer group select-none";
                el.draggable = true;
                el.ondblclick = () => openPageEditor(item.id);
                el.innerHTML = `
                    <div class="cursor-move text-slate-300 hover:text-indigo-500 px-1 transition-colors"><i class="fas fa-grip-vertical text-lg"></i></div>
                    <div class="relative pointer-events-none group-hover:scale-105 transition-transform duration-200">
                        <img src="${item.thumbnail}" class="w-12 h-16 object-contain bg-slate-50 border border-slate-200 rounded shadow-sm">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition rounded"></div>
                    </div>
                    <div class="flex-1 min-w-0 pointer-events-none">
                        <h4 class="text-base font-bold text-slate-800 truncate mb-1">${item.name}</h4>
                        <p class="text-xs text-slate-500 flex items-center gap-2">
                            <span class="bg-slate-100 px-2 py-0.5 rounded text-slate-600 font-mono">${item.pageIndices.length} 頁</span>
                            <span class="text-slate-300">|</span>
                            <span>原始: ${item.originalPageCount} 頁</span>
                        </p>
                    </div>
                    <button onclick="removeFile('${item.id}')" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 transition-all z-10" title="移除檔案">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                el.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/type', 'file_item'); e.dataTransfer.setData('text/index', displayIndex); el.classList.add('dragging-source'); });
                el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('drag-target-hover'); });
                el.addEventListener('dragleave', () => { el.classList.remove('drag-target-hover'); });
                el.addEventListener('drop', (e) => { e.preventDefault(); el.classList.remove('drag-target-hover'); if (e.dataTransfer.getData('text/type') !== 'file_item') return; const fi = parseInt(e.dataTransfer.getData('text/index')); const ti = displayIndex; if (fi !== ti && !isNaN(fi)) { const m = mergeFiles[fi]; mergeFiles.splice(fi, 1); mergeFiles.splice(ti, 0, m); renderMergeList(); } });
                el.addEventListener('dragend', () => { el.classList.remove('dragging-source'); document.querySelectorAll('.drag-target-hover').forEach(i => i.classList.remove('drag-target-hover')); });
                listEl.appendChild(el);
            });
            updateMergeBtnState();
        }

        function removeFile(id) { mergeFiles = mergeFiles.filter(f => f.id !== id); renderMergeList(); }

        async function openPageEditor(fileId) {
            const fileObj = mergeFiles.find(f => f.id === fileId);
            if (!fileObj) return;
            currentEditingFileId = fileId;
            editorPagesData = []; 
            editorDragCounter = 0;
            document.getElementById('editor-drop-overlay').classList.add('hidden');
            const modal = document.getElementById('page-editor-modal');
            const grid = document.getElementById('page-grid');
            const loader = document.getElementById('editor-loading');
            document.getElementById('editor-filename').innerText = fileObj.name;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10); // Fade in
            grid.innerHTML = ''; 
            loader.classList.remove('hidden');
            renderSidebarList();
            try {
                const arrayBuffer = await getFileArrayBuffer(fileObj);
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer.slice(0) }).promise;
                for (let i = 0; i < fileObj.pageIndices.length; i++) {
                    const originalIndex = fileObj.pageIndices[i];
                    editorPagesData.push({ fileId: fileId, pageIndex: originalIndex, imgSrc: null, status: 'pending' });
                }
                renderEditorGrid(); 
            } catch(e) { console.error(e); alert("無法讀取頁面"); } finally { loader.classList.add('hidden'); }
        }

        function renderEditorGrid() {
            const grid = document.getElementById('page-grid');
            grid.innerHTML = ''; 
            editorPagesData.forEach((pageData, displayIndex) => {
                const div = document.createElement('div');
                div.className = "page-card bg-white p-3 rounded-xl shadow-sm border border-slate-200 relative group select-none transition-all hover:border-indigo-300";
                div.draggable = true;
                let imgContent = (pageData.status === 'loaded' && pageData.imgSrc) ? `<img src="${pageData.imgSrc}" class="w-full h-full object-contain shadow-sm">` : `<div class="w-full h-full bg-slate-50 flex items-center justify-center text-slate-300 lazy-placeholder rounded" data-idx="${displayIndex}"><i class="fas fa-spinner fa-spin"></i></div>`;
                div.innerHTML = `
                    <div class="absolute top-2 right-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="removePageInEditor(${displayIndex})" class="bg-white text-slate-400 hover:text-red-500 border border-slate-200 rounded-full w-7 h-7 flex items-center justify-center shadow-md hover:scale-110 transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="w-full aspect-[1/1.4] bg-slate-50 mb-3 overflow-hidden rounded-lg border border-slate-100 pointer-events-none flex items-center justify-center">
                        ${imgContent}
                    </div>
                    <div class="flex justify-between items-center text-xs text-slate-400 font-mono">
                        <span class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">P.${displayIndex + 1}</span>
                        <span>原始 ${pageData.pageIndex + 1}</span>
                    </div>
                `;
                div.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/type', 'page_item'); e.dataTransfer.setData('text/index', displayIndex); div.classList.add('dragging-source'); isDraggingPage = true; });
                div.addEventListener('dragover', (e) => { e.preventDefault(); if (e.dataTransfer.getData('application/x-nuvex-file-id')) div.classList.add('sidebar-insert-hover'); else div.classList.add('drag-target-hover'); });
                div.addEventListener('dragleave', () => { div.classList.remove('drag-target-hover'); div.classList.remove('sidebar-insert-hover'); });
                div.addEventListener('drop', async (e) => { e.preventDefault(); div.classList.remove('drag-target-hover'); div.classList.remove('sidebar-insert-hover'); isDraggingPage = false; const sid = e.dataTransfer.getData('application/x-nuvex-file-id'); if (sid) { e.stopPropagation(); await handleSidebarFileDrop(sid, displayIndex); return; } if(e.dataTransfer.getData('text/type') !== 'page_item') return; const fi = parseInt(e.dataTransfer.getData('text/index')); const ti = displayIndex; if (fi !== ti && !isNaN(fi)) { const item = editorPagesData[fi]; editorPagesData.splice(fi, 1); editorPagesData.splice(ti, 0, item); renderEditorGrid(); } });
                div.addEventListener('dragend', () => { div.classList.remove('dragging-source'); document.querySelectorAll('.drag-target-hover, .sidebar-insert-hover').forEach(x => x.classList.remove(x.classList[x.length-1])); isDraggingPage = false; });
                grid.appendChild(div);
                if (pageData.status === 'pending') { const p = div.querySelector('.lazy-placeholder'); if(p && imageObserver) imageObserver.observe(p); }
            });
            document.getElementById('editor-page-count').innerText = editorPagesData.length;
        }

        async function loadPageThumbnail(idx, imgElement) {
            const data = editorPagesData[idx];
            if (!data || data.status === 'loaded') return;
            try {
                const fileObj = mergeFiles.find(f => f.id === data.fileId);
                if(!fileObj) return;
                const ab = await getFileArrayBuffer(fileObj);
                const loadingTask = pdfjsLib.getDocument({ data: ab.slice(0) });
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(data.pageIndex + 1);
                const viewport = page.getViewport({ scale: 0.3 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                data.imgSrc = canvas.toDataURL();
                data.status = 'loaded';
                if (imgElement && imgElement.parentNode) imgElement.parentNode.innerHTML = `<img src="${data.imgSrc}" class="w-full h-full object-contain shadow-sm">`;
            } catch (e) { console.error("Thumbnail failed", e); }
        }

        function removePageInEditor(index) { editorPagesData.splice(index, 1); renderEditorGrid(); }

        async function handleSidebarFileDrop(fileId, insertAtIndex = -1) {
            const fileObj = mergeFiles.find(f => f.id === fileId);
            if (!fileObj) return;
            const loader = document.getElementById('editor-loading');
            loader.classList.remove('hidden');
            try {
                const ab = await getFileArrayBuffer(fileObj);
                const pdf = await pdfjsLib.getDocument({ data: ab.slice(0) }).promise;
                const newPages = [];
                for (let i = 1; i <= pdf.numPages; i++) { newPages.push({ fileId: fileId, pageIndex: i - 1, imgSrc: null, status: 'pending' }); }
                if (insertAtIndex >= 0) editorPagesData.splice(insertAtIndex, 0, ...newPages);
                else editorPagesData.push(...newPages);
                renderEditorGrid();
            } catch(e) { alert("匯入失敗: " + e.message); } finally { loader.classList.add('hidden'); }
        }

        async function handleExternalFileDropInEditor(files, insertAtIndex = -1) {
            const loader = document.getElementById('editor-loading');
            loader.classList.remove('hidden');
            try {
                let hasPDF = false; const newItems = [];
                for (const file of files) {
                    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) continue;
                    hasPDF = true;
                    const fileId = Date.now() + Math.random().toString(36).substr(2, 9);
                    let ab = await file.arrayBuffer();
                    let decryptedBlob = null;
                    try {
                        const pdfDoc = await smartLoadPdf(ab.slice(0));
                        if (pdfDoc.isEncrypted) {
                            const decryptedBytes = await pdfDoc.save();
                            ab = decryptedBytes.buffer;
                            decryptedBlob = new Blob([decryptedBytes], { type: 'application/pdf' });
                        }
                    } catch(e) {
                        const pwd = prompt(`檔案「${file.name}」已加密，請輸入密碼以插入：`);
                        if (pwd) {
                            try {
                                const pdfDoc = await smartLoadPdf(ab.slice(0), pwd);
                                const decryptedBytes = await pdfDoc.save();
                                decryptedBlob = new Blob([decryptedBytes], { type: 'application/pdf' });
                                ab = decryptedBytes.buffer; 
                            } catch { alert("密碼錯誤"); continue; }
                        } else continue; 
                    }
                    const loadingTask = pdfjsLib.getDocument({ data: ab.slice(0) });
                    const pdf = await loadingTask.promise;
                    const p1 = await pdf.getPage(1);
                    const v = p1.getViewport({ scale: 0.3 });
                    const c = document.createElement('canvas'); c.width = v.width; c.height = v.height;
                    await p1.render({ canvasContext: c.getContext('2d'), viewport: v }).promise;
                    const fObj = { id: fileId, file: file, name: file.name, originalPageCount: pdf.numPages, pageIndices: Array.from({length: pdf.numPages},(_,k)=>k), thumbnail: c.toDataURL(), blob: decryptedBlob };
                    mergeFiles.push(fObj);
                    for(let i=0; i<pdf.numPages; i++) newItems.push({ fileId: fileId, pageIndex: i, imgSrc: null, status: 'pending' });
                }
                if (newItems.length > 0) {
                    if (insertAtIndex >= 0) editorPagesData.splice(insertAtIndex, 0, ...newItems);
                    else editorPagesData.push(...newItems);
                    renderEditorGrid(); renderSidebarList();
                }
            } catch(e) { console.error(e); } finally { loader.classList.add('hidden'); }
        }

        function renderSidebarList() {
            const sidebar = document.getElementById('sidebar-file-list');
            sidebar.innerHTML = '';
            const otherFiles = mergeFiles.filter(f => f.id !== currentEditingFileId);
            if (otherFiles.length === 0) { sidebar.innerHTML = '<div class="text-center text-slate-400 text-xs py-10 flex flex-col items-center"><i class="fas fa-inbox text-2xl mb-2 opacity-50"></i>無其他檔案</div>'; return; }
            otherFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = "sidebar-item bg-white border border-slate-200 p-3 rounded-xl shadow-sm hover:shadow-md flex items-center gap-3 transition cursor-grab group";
                item.draggable = true;
                item.innerHTML = `
                    <div class="text-slate-300 group-hover:text-indigo-400 transition-colors"><i class="fas fa-grip-vertical"></i></div>
                    <img src="${file.thumbnail}" class="w-10 h-12 object-contain bg-slate-50 border rounded shadow-sm pointer-events-none">
                    <div class="flex-1 min-w-0 pointer-events-none">
                        <div class="text-sm font-bold text-slate-700 truncate">${file.name}</div>
                        <div class="text-xs text-slate-400 font-mono">${file.pageIndices.length} 頁</div>
                    </div>
                `;
                item.addEventListener('dragstart', (e) => { e.dataTransfer.setData('application/x-nuvex-file-id', file.id); e.dataTransfer.setData('application/x-nuvex-sort-id', file.id); e.dataTransfer.effectAllowed = 'copyMove'; item.style.opacity = '0.5'; });
                item.addEventListener('dragend', () => item.style.opacity = '1');
                item.addEventListener('dragover', (e) => { e.preventDefault(); item.classList.add('sidebar-target-hover'); });
                item.addEventListener('dragleave', () => item.classList.remove('sidebar-target-hover'));
                item.addEventListener('drop', (e) => {
                    e.preventDefault(); item.classList.remove('sidebar-target-hover');
                    const sid = e.dataTransfer.getData('application/x-nuvex-sort-id');
                    if (sid && sid !== file.id) {
                        const fi = mergeFiles.findIndex(x => x.id === sid);
                        const ti = mergeFiles.findIndex(x => x.id === file.id);
                        if (fi > -1 && ti > -1) { const mv = mergeFiles[fi]; mergeFiles.splice(fi, 1); mergeFiles.splice(ti, 0, mv); renderSidebarList(); renderMergeList(); }
                    }
                });
                sidebar.appendChild(item);
            });
        }

        async function saveEditorChanges() {
            const fileObj = mergeFiles.find(f => f.id === currentEditingFileId);
            if (!fileObj) return;
            const btn = document.getElementById('btn-save-editor');
            const ot = btn.innerHTML;
            btn.innerHTML = '<div class="loader mr-2 w-4 h-4"></div> 處理中...'; btn.disabled = true;
            try {
                const { PDFDocument } = PDFLib;
                const newPdf = await PDFDocument.create();
                const loadedSourcePdfs = new Map();
                for (const pData of editorPagesData) {
                    let srcPdf = loadedSourcePdfs.get(pData.fileId);
                    if (!srcPdf) {
                        const sourceFileObj = mergeFiles.find(f => f.id === pData.fileId);
                        if (!sourceFileObj) continue; 
                        const ab = await getFileArrayBuffer(sourceFileObj);
                        srcPdf = await smartLoadPdf(ab);
                        loadedSourcePdfs.set(pData.fileId, srcPdf);
                    }
                    const [copiedPage] = await newPdf.copyPages(srcPdf, [pData.pageIndex]);
                    newPdf.addPage(copiedPage);
                }
                const pdfBytes = await newPdf.save();
                const newBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                fileObj.blob = newBlob; 
                fileObj.originalPageCount = editorPagesData.length;
                fileObj.pageIndices = Array.from({ length: editorPagesData.length }, (_, k) => k);
                if (editorPagesData.length > 0) fileObj.thumbnail = editorPagesData[0].imgSrc;
                closeEditor(); renderMergeList();
            } catch (err) { console.error(err); alert("儲存失敗：" + err.message); } finally { btn.innerHTML = ot; btn.disabled = false; }
        }

        function setupEditorDropZone() {
            const container = document.getElementById('page-editor-modal'); 
            const overlay = document.getElementById('editor-drop-overlay');
            container.addEventListener('dragenter', (e) => { if (e.dataTransfer.types.includes('Files')) { e.preventDefault(); editorDragCounter++; if (editorDragCounter===1) overlay.classList.remove('hidden'); } });
            container.addEventListener('dragleave', (e) => { if (e.dataTransfer.types.includes('Files')) { e.preventDefault(); editorDragCounter--; if (editorDragCounter<=0) { editorDragCounter=0; overlay.classList.add('hidden'); } } });
            container.addEventListener('dragover', (e) => { if (e.dataTransfer.types.includes('Files')) e.preventDefault(); });
            container.addEventListener('drop', async (e) => {
                if (e.dataTransfer.files?.length > 0) { e.preventDefault(); editorDragCounter=0; overlay.classList.add('hidden'); await handleExternalFileDropInEditor(e.dataTransfer.files); return; }
            });
        }

        function closeEditor() {
            const modal = document.getElementById('page-editor-modal');
            modal.classList.add('opacity-0'); // Fade out
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('editor-drop-overlay').classList.add('hidden');
                editorDragCounter = 0; currentEditingFileId = null; editorPagesData = []; isDraggingPage = false; 
                if (imageObserver) imageObserver.disconnect();
                renderMergeList();
            }, 300);
        }

        function updateMergeBtnState() {
            const btn = document。getElementById('btn-merge');
            const hasFiles = mergeFiles.length > 0;
            if (!hasFiles) { 
                btn.disabled = true; 
                btn.classList.add('opacity-50'， 'cursor-not-allowed'， 'grayscale');
                document.getElementById('empty-state-hint').classList.remove('hidden');
            } else { 
                btn.disabled = false; 
                btn.classList。remove('opacity-50'， 'cursor-not-allowed'， 'grayscale'); 
                document.getElementById('empty-state-hint')。classList。add('hidden');
            }
        }

        async function executeMerge() {
            if (mergeFiles。length < 1) return;
            const btn = document。getElementById('btn-merge')， ot = btn。innerHTML;
            btn。innerHTML = '<div class="loader mr-2"></div> 處理中...'; btn。disabled = true;
            try {
                const { PDFDocument } = PDFLib;
                const mp = await PDFDocument.create();
                for (const it / mergeFiles) {
                    if (!it.pageIndices.length) continue;
                    const ab = await getFileArrayBuffer(it);
                    const p = await smartLoadPdf(ab);
                    const cp = await mp.copyPages(p, it.pageIndices); cp.forEach(x => mp.addPage(x));
                }
                const u = URL.createObjectURL(new Blob([await mp.save()], { type: 'application/pdf' }));
                const n = new Date()， pad = (n) => String(n)。padStart(2， '0');
                const fn = `NuvexPDF_${n。getFullYear()}${pad(n。getMonth()+1)}${pad(n。getDate())}${pad(n。getHours())}${pad(n。getMinutes())}.pdf`;
                const dl = document.getElementById('merge-download'); dl.href = u; dl.download = fn;
                btn。classList。add('hidden'); dl.classList.remove('hidden');
            } catch (e) { alert(e.message || "合併失敗"); } 
            finally { if (document.getElementById('merge-download').classList.contains('hidden')) { btn.innerHTML = ot; btn.disabled = false; } }
        }

        function initAutoScroll() {
            const container = document.getElementById('modal-scroll-container');
            document.addEventListener('dragover', (e) => { if (isDraggingPage) currentMouseY = e.clientY; });
            function loop() {
                if (isDraggingPage) {
                    const rect = container.getBoundingClientRect();
                    if (currentMouseY > 0) {
                        if (currentMouseY < rect.top + 100) container.scrollTop -= 15;
                        else if (currentMouseY > rect.bottom - 100) container.scrollTop += 15;
                    }
                } scrollAnimationId = requestAnimationFrame(loop);
            } scrollAnimationId = requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
